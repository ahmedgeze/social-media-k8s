# Grafana Helm Values for Minikube
# Pre-configured with Prometheus, Loki, Tempo datasources

adminUser: admin
adminPassword: admin123

persistence:
  enabled: false

resources:
  requests:
    memory: "128Mi"
    cpu: "50m"
  limits:
    memory: "256Mi"
    cpu: "200m"

service:
  type: ClusterIP
  port: 3000

# Datasources
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        uid: prometheus
        url: http://prometheus-server:80
        access: proxy
        isDefault: true
        editable: false

      - name: Loki
        type: loki
        uid: loki
        url: http://loki:3100
        access: proxy
        editable: false
        jsonData:
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: "traceId=(\\w+)"
              name: TraceID
              url: "$${__value.raw}"

      - name: Tempo
        type: tempo
        uid: tempo
        url: http://tempo:3100
        access: proxy
        editable: false
        jsonData:
          tracesToLogs:
            datasourceUid: loki
            tags: ['app', 'namespace']
            mappedTags: [{ key: 'service.name', value: 'app' }]
            mapTagNamesEnabled: true
            filterByTraceID: true
          serviceMap:
            datasourceUid: prometheus

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Pre-built dashboards
dashboards:
  default:
    spring-boot:
      gnetId: 12900  # Spring Boot 2.1 Statistics
      revision: 2
      datasource: Prometheus

    kubernetes-cluster:
      gnetId: 7249   # Kubernetes Cluster
      revision: 1
      datasource: Prometheus

    jvm-micrometer:
      gnetId: 4701   # JVM Micrometer
      revision: 9
      datasource: Prometheus

# Grafana.ini configuration
grafana.ini:
  server:
    root_url: "%(protocol)s://%(domain)s/"
  analytics:
    reporting_enabled: false
    check_for_updates: false
  log:
    mode: console
  grafana_net:
    url: https://grafana.net
  feature_toggles:
    enable: tempoSearch tempoBackendSearch
